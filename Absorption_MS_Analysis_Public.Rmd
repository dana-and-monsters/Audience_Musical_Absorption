---
title: "Revised Statistical Analysis: Absorption"
author: "Dana Swarbrick"
date: "30/07/2023"
output: 
  html_document: 
    toc: true
  pdf_document: default
---

# File Description 
This file contains the analyses for the revised absorption manuscript (Swarbrick, Martin, et al., 2023).

# Abstract 
Musical absorption is a multi-dimensional phenomenon that has been understood variously in relation to strong, immersive, and transformative musical encounters. Previous research has examined musical absorption in accounts of contemporary dance performances, everyday music listening situations, and during performances by professional ensembles. In this exploratory paper, we used phenomenological and psychological approaches to understand audience members’ musical absorption and affective experience at the MusicLab Copenhagen with the Danish String Quartet research concert. The analysis of social context (live vs. livestreamed audience participation) and audience motion in relation to absorption offers novel insight into live music experience. 
To aid further conceptual clarification and phenomenological understanding, we also examined musical absorption’s relation to 1) attention, mind-wandering, and senses of transformation; 2) related affective phenomena including feeling moved/touched and awe; 3) motion and stillness; and 4) live and livestreamed audience experience. There were 91 participants in the live audience and 43 participants in the livestreaming audience who completed questionnaires after each piece in the concert and who had their motion measured. Drawing on methods from experimental psychology, we found that 1) being ‘absorbed in the music’ was not related to mind-wandering, yet it was related to a sense of positive transformation; 2) musical absorption was related to experiences of feeling moved, awe, connectedness, and enjoyment, and to reports of being an admirer before the concert and familiarity with the music; and 3) motion was an indicator of an embodied experience of musical absorption that varied with social context, as reports of musical absorption were related to more motion in the live audience and less motion in the livestreaming audience. The interdisciplinary nature of this paper allows us to engage in a phenomenologically informed and empirically enriched discussion of musical absorption and related affective and attentional dynamics.

# Load data
```{r}
df.full<-readRDS(file = "../output/Prepared_Data.Rda")

# rename ParticipantCode to Pt_ID to shorten
names(df.full)[1]<-"Pt_ID"
```

# Import libraries
```{r}
packages = c("GPArotation", "rmcorr", "rstatix", "ltm","reshape2", "psych", "car", "emmeans", "nlme","lme4", "tidyverse", "ggsignif", "FactoMineR", "factoextra", "magrittr", "pwr", "easystats", "ggpubr") #psych: Revelle, 2020; GPArotation: Bernaards and Jennrich, 2005) . rstatix and ggpubr for doing the RM -ANOVAs for checking the effect of awareness of body and movement on Absorption factor.

## Now load or install & load all
package.check <- lapply(
  packages,
  FUN = function(x) {
    if (!require(x, character.only = TRUE)) {
      install.packages(x, dependencies = TRUE)
      library(x, character.only = TRUE)
    }
  }
)

source("useful_functions.R")
```

# Citations
```{r}
citation()
citation("lme4")
citation("rstatix")
citation("rmcorr")
citation("ggplot2")
citation("ggpubr")
```


# 3.1 Characterize Participant Sample
Section 3.1 Participants

It is important to describe the sample upon which these findings are based. 

It is especially important to examine differences in AIMS which is important for understanding state-based musical absorption.
```{r}
# AIMS
df.full%>%group_by(group)%>%summarise(mean = mean(AIMS, na.rm = TRUE), sd = sd(AIMS, na.rm = TRUE))
```

## AIMS: Two-sample t-test
```{r}
live_aims<-df.full%>%filter(group == "Live")%>%select(AIMS)%>%na.omit() # n = 91
virtual_aims<-df.full%>%filter(group == "Virtual")%>%select(AIMS)%>%na.omit() # n = 31

# except several people in the virtual audience have 0s as their value for the AIMS scale. This is because the AIMS score is a sum. People who haven't responded at all are summing to 0 so need to remove the 0s or convert them to NAs.
virtual_aims[virtual_aims==0]<-NA
virtual_aims<-na.omit(virtual_aims) # n = 31
t.test(live_aims, virtual_aims)

## I should do this for the AIMS score in the actual dataframe as well.
test<-df.full%>%select(Pt_ID, AIMS)
df.full$AIMS[df.full$AIMS == 0]<-NA

summary(live_aims)
summary(virtual_aims)

#could also test with syntax:
t.test(df.full$AIMS~df.full$group)
```
## Personal relation
Chi-square to assess difference in the count of whether there are more people with a personal relation in the live audience than the livestreaming audience.

Even though there are more participants with a personal relation in the live audience, this was not statistically significant. 
```{r}
tab<-with(df.full, table(personal_relation, group))
tab
chisq.test(tab)
```
# 3.2 Absorption, Attention, Mind-wandering, and Transformation

## 3.2.1 Multi-level reliability

**Create musical absorption measure**
To understand the relation between musical absorption, attention, and affect, we need to compute a score of musical absorption. While the phenomenologists have different opinions of what musical absorption is, we need to come to an agreement on what that really is. Based on the previous literature, we can agree that musical absorption consists of being absorbed in the music, being attentive to the music, and losing a sense of time. From this measure we can then assess what the relation is between the other items and this score of musical absorption.

```{r}
musical_absorption_items<-c("absorbed_music", "sense_time", "attentive")

musical_absorption<-df.full%>%select(Pt_ID, contains("absorbed_music"), contains("sense_time"), contains("attentive"))
musical_absorption%<>%mutate(mus_abs_Beethoven = (absorbed_music_Beethoven+sense_time_Beethoven+attentive_Beethoven)/3,
                             mus_abs_Schnittke = (absorbed_music_Schnittke+sense_time_Schnittke+attentive_Schnittke)/3,
                             mus_abs_Folk = (absorbed_music_Folk+sense_time_Folk+attentive_Folk)/3)
mus_abs<-musical_absorption%>%select(Pt_ID, contains("mus_abs"))

musical_absorption<-tibble::rowid_to_column(musical_absorption, "ID")
```

```{r}
musical_absorption.long<-musical_absorption%>%pivot_longer(!c(Pt_ID, ID),
                        names_to = c("question", "piece"),
                        names_pattern ="(.*)_(.*)",
                        values_to = "response")

musical_absorption.wide<-musical_absorption.long%>%pivot_wider(names_from = question, values_from = response)
```

Repeated measures correlations
```{r}
variables = c("absorbed_music", "sense_time", "attentive")
corMat<-rmcorr_mat(Pt_ID, variables, dataset = musical_absorption.wide)
corMat
corMat$summary # all significant
```

Followed along with this tutorial: 
https://personality-project.org/courses/350/350.wk.7b.html

```{r}
describe(musical_absorption.wide)
```

```{r}
describeBy(musical_absorption.wide, group="ID")
```

```{r}
#convert piece to numeric
musical_absorption.wide$Piece<-as.numeric(factor(musical_absorption.wide$piece))
#now find the within and between individual correlations
musical_absorption.wide.num<-musical_absorption.wide%>%select(-Pt_ID, -piece)
sb <- statsBy(musical_absorption.wide.num, group="ID",cors=TRUE)
sb
```

```{r}
# r within group
lowerMat(sb$rwg)
```
```{r}
#r between group
lowerMat(sb$rbg)
```
```{r}
round(sb$within,2)
```

Check reliability/internal consistency with a multi-level measure: multi-level reliability

To understand output of mlr, this might be helpful: https://www.google.ca/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&ved=2ahUKEwjW7rKklomBAxUBSPEDHVD0A-sQFnoECBMQAQ&url=https%3A%2F%2Fosf.io%2F2y3w9%2Fdownload&usg=AOvVaw3I99raIRhVuOgY7EhDVsQ9&opi=89978449

```{r}
mg <- mlr(data.frame(as.matrix(musical_absorption.wide.num)),grp="ID",Time="Piece",items=c("absorbed_music","sense_time","attentive"),plot=TRUE)# multilevel.reliability also works as the function call
mg

#subset for plotting
subset_for_plotting<-musical_absorption.wide.num%>%filter(ID %in% c(1,2,3,4))  

mlPlot(data.frame(as.matrix(subset_for_plotting)),grp="ID",Time = "Piece", items = c("absorbed_music","sense_time","attentive")) # before I changed data to data.frame(as.matrix(...),  I got this error: Error in unique.default(x, nmax = nmax) :
#unique() applies only to vectors
```


Add this average into the dataframe
```{r}
df.full%<>%full_join(mus_abs, by = "Pt_ID")
```

# Explore the data

## Histograms of each of the variables
These are included in Table 1: Absorption, Attention, and Affect
```{r}
items<-c("own_world", "absorbed_music", "daydream", "sense_time", "distracted", "attentive", "attention_others", "attention_sensations", "positively_transformed", "negatively_transformed")

df_absorption<-df.full%>%select("Pt_ID",group, contains(items))

df_absorption_nona<-na.omit(df_absorption)

df_absorb.long<-df_absorption_nona%>%pivot_longer(!c(Pt_ID,group),
                        names_to = c("question", "piece"),
                        names_pattern ="(.*)_(.*)",
                        values_to = "response")

df_absorb.wide<-df_absorb.long%>%pivot_wider(names_from = question, values_from = response)

df_absorb.wide$piece<-factor(df_absorb.wide$piece, levels = c("Beethoven", "Schnittke", "Folk"), labels = c("B", "S", "F"))

# own world
df_absorb.wide%>%select(piece, own_world)%>%drop_na()%>%
  ggplot(aes(x=own_world))+
    geom_bar(stat="count")+
    theme_minimal()+
    theme(axis.text.x=element_blank(),
          axis.text.y=element_blank())+
    labs(x = "", y = "")+
    facet_grid(cols = vars(piece))

graphname<-paste0("../revised_plots/hist_own_world.png")
ggsave(graphname,width = 4, height = 3, units = 'cm')

# absorbed music
df_absorb.wide%>%select(piece, absorbed_music)%>%drop_na()%>%
  ggplot(aes(x=absorbed_music))+
    geom_bar(stat="count")+
    theme_minimal()+
    theme(axis.text.x=element_blank(),
          axis.text.y=element_blank())+
    labs(x = "", y = "")+
    facet_grid(cols = vars(piece))

graphname<-paste0("../revised_plots/hist_absorbed_music.png")
ggsave(graphname,width = 4, height = 3, units = 'cm')

# daydream
df_absorb.wide%>%select(piece, daydream)%>%drop_na()%>%
  ggplot(aes(x=daydream))+
    geom_bar(stat="count")+
    theme_minimal()+
    theme(axis.text.x=element_blank(),
          axis.text.y=element_blank())+
    labs(x = "", y = "")+
    facet_grid(cols = vars(piece))

graphname<-paste0("../revised_plots/hist_daydream.png")
ggsave(graphname,width = 4, height = 3, units = 'cm')

# sense time
df_absorb.wide%>%select(piece, sense_time)%>%drop_na()%>%
  ggplot(aes(x=sense_time))+
    geom_bar(stat="count")+
    theme_minimal()+
    theme(axis.text.x=element_blank(),
          axis.text.y=element_blank())+
    labs(x = "", y = "")+
    facet_grid(cols = vars(piece))

graphname<-paste0("../revised_plots/hist_sensetime.png")
ggsave(graphname,width = 4, height = 3, units = 'cm')

# distracted
df_absorb.wide%>%select(piece, distracted)%>%drop_na()%>%
  ggplot(aes(x=distracted))+
    geom_bar(stat="count")+
    theme_minimal()+
    theme(axis.text.x=element_blank(),
          axis.text.y=element_blank())+
    labs(x = "", y = "")+
    facet_grid(cols = vars(piece))

graphname<-paste0("../revised_plots/hist_distracted.png")
ggsave(graphname,width = 4, height = 3, units = 'cm')

# attentive
df_absorb.wide%>%select(piece, attentive)%>%drop_na()%>%
  ggplot(aes(x=attentive))+
    geom_bar(stat="count")+
    theme_minimal()+
    theme(axis.text.x=element_blank(),
          axis.text.y=element_blank())+
    labs(x = "", y = "")+
    facet_grid(cols = vars(piece))

graphname<-paste0("../revised_plots/hist_attentive.png")
ggsave(graphname,width = 4, height = 3, units = 'cm')

# attention others
df_absorb.wide%>%select(piece, attention_others)%>%drop_na()%>%
  ggplot(aes(x=attention_others))+
    geom_bar(stat="count")+
    theme_minimal()+
    theme(axis.text.x=element_blank(),
          axis.text.y=element_blank())+
    labs(x = "", y = "")+
    facet_grid(cols = vars(piece))

graphname<-paste0("../revised_plots/hist_attention_others.png")
ggsave(graphname,width = 4, height = 3, units = 'cm')

# attention sensations
df_absorb.wide%>%select(piece, attention_sensations)%>%drop_na()%>%
  ggplot(aes(x=attention_sensations))+
    geom_bar(stat="count")+
    theme_minimal()+
    theme(axis.text.x=element_blank(),
          axis.text.y=element_blank())+
    labs(x = "", y = "")+
    facet_grid(cols = vars(piece))

graphname<-paste0("../revised_plots/hist_attention_sensations.png")
ggsave(graphname,width = 4, height = 3, units = 'cm')


# positive transformation
df_absorb.wide%>%select(piece, positively_transformed)%>%drop_na()%>%
  ggplot(aes(x=positively_transformed))+
    geom_bar(stat="count")+
    theme_minimal()+
    theme(axis.text.x=element_blank(),
          axis.text.y=element_blank())+
    labs(x = "", y = "")+
    facet_grid(cols = vars(piece))

graphname<-paste0("../revised_plots/hist_pos_transform.png")
ggsave(graphname,width = 4, height = 3, units = 'cm')

# negative transformation
df_absorb.wide%>%select(piece, negatively_transformed)%>%drop_na()%>%
  ggplot(aes(x=negatively_transformed))+
    geom_bar(stat="count")+
    theme_minimal()+
    theme(axis.text.x=element_blank(),
          axis.text.y=element_blank())+
    labs(x = "", y = "")+
    facet_grid(cols = vars(piece))

graphname<-paste0("../revised_plots/hist_neg_transform.png")
ggsave(graphname,width = 4, height = 3, units = 'cm')

```

## Correlations between absorption items and positive and negative affect by piece.
This is located in the supplementary material in S4 and supplementary figure 2.

```{r}
items<-c("positive", "negative", "own_world", "absorbed_music", "daydream", "sense_time", "distracted", "attentive", "attention_others", "attention_sensations", "positively_transformed", "negatively_transformed")

df<-df.full%>%select("Pt_ID", contains(items))%>%select(-contains("Positive_Affect"))

df.long<-df%>%pivot_longer(!Pt_ID,
                        names_to = c("question", "piece"),
                        names_pattern ="(.*)_(.*)",
                        values_to = "response")

df.wide<-df.long%>%pivot_wider(names_from = question, values_from = response)

Beethoven<-df.wide%>%filter(piece == "Beethoven")
Schnittke<-df.wide%>%filter(piece == "Schnittke")
Folk<-df.wide%>%filter(piece == "Folk")

colours_DSQ<-c("#2d769a", "white","#b34036")

corData<-Beethoven%>%select(-Pt_ID, -piece)
corData<-na.omit(corData)
samples = nrow(corData)
title = "Beethoven"
subtitle = paste0("Kendall Correlations (BH adj) (n = ", samples, ")")
chart.correlation(corData, colours_DSQ, title, subtitle)

# check the p-values
correlation = adj.cor(corData, p.adjust = TRUE, p.adjust.method = "BH", threshold = 0.05, cor.method = "kendall")

corData<-Schnittke%>%select(-Pt_ID, -piece)
corData<-na.omit(corData)
samples = nrow(corData)
title = "Schnittke"
subtitle = paste0("Kendall Correlations (BH adj) (n = ", samples, ")")
chart.correlation(corData, colours_DSQ, title, subtitle)

# check the p-values
correlation = adj.cor(corData, p.adjust = TRUE, p.adjust.method = "BH", threshold = 0.05, cor.method = "kendall")

corData<-Folk%>%select(-Pt_ID, -piece)
corData<-na.omit(corData)
samples = nrow(corData)
title = "Folk"
subtitle = paste0("Kendall Correlations (BH adj) (n = ", samples, ")")
chart.correlation(corData, colours_DSQ, title, subtitle)

# check the p-values
correlation = adj.cor(corData, p.adjust = TRUE, p.adjust.method = "BH", threshold = 0.05, cor.method = "kendall")

graphname<-paste0("../revised_plots/", title, "_pos_neg_correlation.png")
ggsave(graphname, width = 12, height = 10, units = 'cm', dpi = 500)

```

# 3.3 Repeated Measures Correlations
Section 3.3 What is the relation between absorption in the music, the other attention/affect items, and other affective variables?

Correlations between variables by piece needs to be conducted with a repeated measures approach because we measured the scales after Beethoven, Schnittke, and the Folk (3 times)

There is a toolbox that was developed just for this kind of analysis called rmcorr (Bakdash & Marusich, 2017). https://www.frontiersin.org/articles/10.3389/fpsyg.2017.00456/full

"Rmcorr accounts for non-independence among observations using analysis of covariance (ANCOVA) to statistically adjust for inter-individual variability. By removing measured variance between-participants, rmcorr provides the best linear fit for each participant using parallel regression lines (the same slope) with varying intercepts. Like a Pearson correlation coefficient (r), the rmcorr coefficient (rrm) is bounded by −1 to 1 and represents the strength of the linear association between two variables. Also akin to the Pearson correlation, the null hypothesis for rmcorr is ρrm = 0, and the research/alternative hypothesis is ρrm 6= 0. Unlike the Pearson correlation, which assesses the inter-individual association because it assumes each paired data point is Independent and Identically Distributed (IID), rmcorr evaluates the overall or common intra-individual association between two measures. Because rmcorr takes into account non-independence, it tends to yield much greater power than data that are averaged in order to meet the IID assumption for simple regression/correlation. Hence, rmcorr can detect associations between variables that might otherwise be obscured or spurious due to aggregation or treating non-independent values as IID.

Conceptually, rmcorr is close to a null multilevel model (i.e., varying intercept and a common slope for each individual), but the techniques differ on how they treat/pool variance. Rmcorr assesses the common intra-individual variance in data, whereas multilevel modeling can simultaneously analyze different sources of variance using fixed and random effects. The tradeoff with more complex multilevel models is that they require more data and are more challenging to specify and interpret than simpler analysis of variance (ANOVA)/regression models, such as rmcorr. However, the flexibility of multilevel modeling has benefits: Overall and individual differences can be analyzed simultaneously, models of varying complexity can be systematically compared, and they can provide greater insights into individual differences."

“Rmcorr can be viewed as a “light” version of multilevel modeling because it is comparable to a simple, null multilevel model with random/varying effects of intercept for each individual and a fixed effect (i.e., common/overall) slope (see Appendix C for direct comparisons). However, rmcorr only analyzes intra- individual variance. Multilevel modeling can simultaneously analyze both intra- and inter-individual variance using partial pooling, which permits varying slopes and other parameters that cannot be estimated with simpler techniques.

## Correlation Matrix
This is figure 1 in the manuscript, located in section 3.3 

Include all repeated measures for Beethoven, Schnittke, Folk and Motion measures! 
- connectedness (musicians and audience)
- awe
- km
- absorption
- other scale items

Did not include motion (QoM) and stilling because we might expect the relation between absorption and motion to be different for different pieces due to the sociocultural genre constraints.

```{r}
attention_items<-c("distracted","attention_others", "attention_sensations")
transformation_items<-c("positively_transformed", "negatively_transformed")
daydream_items<-c("own_world", "daydream")

# execute the code so that you know you have the correct data
cormat_df<-df.full%>%select(Pt_ID,contains("mus_abs"), contains(attention_items), contains(transformation_items),contains(daydream_items), contains("KM"), contains("AWE_wonder"), contains("connected_musicians"), contains("connected_audience"), contains("familiar"),contains("enjoy"))

cormat_df.long<-cormat_df%>%pivot_longer(!Pt_ID,
                        names_to = c("var", "piece"),
                        names_pattern ="(.*)_(.*)",
                        values_to = "response")

cormat_df.long<-cormat_df.long%>%filter(var != "connected_audience_streaming", var != "connected_audience_attending")

cormat_df.wide<-pivot_wider(cormat_df.long, names_from = var, values_from = response)
# rename the vars so they appear pretty in the chart
colnames(cormat_df.wide)<-c("Pt_ID", "piece", "Absorption","Distracted","Attention Others", "Attention Sensations", "Positive Transformation", "Negative Transformation", "Own World","Daydream", "Kama Muta","Awe", "Connected Musicians", "Connected Audience","Familiar","Enjoyment")
  
variables<-c("Absorption","Distracted","Attention Others", "Attention Sensations", "Positive Transformation", "Negative Transformation", "Own World","Daydream", "Kama Muta","Awe", "Connected Musicians", "Connected Audience","Familiar","Enjoyment")

cormat_df.wide%<>%filter(piece !="Bach")

# removing NA does change the results. Therefore proceed with caution.
#cormat_df.wide%<>%na.omit()

rmc_mat<-rmcorr_mat(Pt_ID, variables, cormat_df.wide, CI.level = 0.95)
```

In the next cell, I need to adjust the rmc_mat so that I only have the matrix that I want visualized.
```{r}
# filter such that measure 1 contains only the absorption items
absorb_item_names<-c("Absorption","Distracted","Attention Others", "Attention Sensations", "Positive Transformation", "Negative Transformation", "Own World","Daydream")
adjusted_summary<-rmc_mat$summary%>%filter(measure1 %in% absorb_item_names)
```

Then create corrected p-values (correction = FDR adjustment)
```{r}
adjusted_matrix<-rmc_mat$matrix[1:length(absorb_item_names), 2:length(variables)] 
r.mat<-adjusted_matrix
```

```{r}
# use the rm_adjusted.corr function outside of the function to be able to check that everything is working. -- the following code is copy pasted and adjusted based on that function.

# assign function variables
cor_df<-cormat_df.wide%>%dplyr::select(-Pt_ID, -piece)
p.adjust = TRUE
p.adjust.method = "fdr"

# p.adjust methods: # c("holm", "hochberg", "hommel", "bonferroni", "BH", "BY",
#   "fdr", "none") # Lol: note that BH and FDR are the same method (it seems) https://support.bioconductor.org/p/110897/#:~:text=%22BH%22%20and%20%22fdr%22%20are%20the%20same%20method.,an%20alias%20for%20%22BH%22.

threshold = 0.05
cor.method = "repeated"
  
if (p.adjust==TRUE){
  p.vals <- p.adjust(adjusted_summary$p.vals, 
                     method = p.adjust.method,
                     n = length(adjusted_summary$p.vals))
} else {
  p.vals = adjusted_summary$p.vals
}

# initiate empty matrix for the p-values only
MAT = matrix(NA, nrow = length(unique(adjusted_summary$measure1)), ncol = length(unique(adjusted_summary$measure2)))

rownames(MAT) = unique(adjusted_summary$measure1)
colnames(MAT) = unique(adjusted_summary$measure2)

# starting to convert p.list to p.values matrix
for(ind in 1:(length(p.vals))){
  var1 = adjusted_summary$measure1[ind] # var1
  var2 = adjusted_summary$measure2[ind] # var1
  p.value = p.vals[ind] # p value
  MAT[var1, var2] = p.value
}

# At this point, MAT has the p.values in a matrix

# subset only the coefficients with p values < 0.05 (or than the specified threshold)

subset = ifelse(MAT < threshold, r.mat, NA)

output = list(adj.p.values = MAT, threshold.r = subset)
```

```{r}
Title = "Correlation Matrix"
colours_blue_white_red<-c("#2d769a", "white","#b34036") # update colors as you wish
Subtitle = "Repeated Measures Correlations - FDR Adjusted"
rm_correlation.matrix(output, colours_blue_white_red, Title, Subtitle)
graphname<-paste0("../revised_plots/RM_Correlations_continuous_fdr_nona.png")
ggsave(graphname, width = 12, height = 10, units = 'cm', dpi = 500, bg = "white")

graphname<-paste0("../revised_plots/Publication_Figures/RM_Correlations_continuous_fdr.jpg")
ggsave(graphname, width = 12, height = 10, units = 'cm', dpi = 500, bg = "white")
```

Inspect the rmcorr values and p-values to write the results section
```{r}
output
output$adj.p.values
output$threshold.r
```



### Split live and livestreaming audiences for correlation chart visualizations
To better understand how the different audiences/social contexts influence the relation between variables, split the data into groups. This is included in the supplementary material figure 2.

#### Live
```{r}
cormat_df<-df.full%>%select(Pt_ID,group,contains("mus_abs"), contains(attention_items), contains(transformation_items),contains(daydream_items), contains("KM"), contains("AWE_wonder"), contains("connected_musicians"), contains("connected_audience"), contains("familiar"),contains("enjoy")) #,  contains("mQoM"), contains("Stilling"))

cormat_df_live<-cormat_df%>%filter(group == "Live")

cormat_df_live.long<-cormat_df_live%>%pivot_longer(!c(Pt_ID,group),
                        names_to = c("var", "piece"),
                        names_pattern ="(.*)_(.*)",
                        values_to = "response")

cormat_df_live.long<-cormat_df_live.long%>%filter(var != "connected_audience_streaming", var != "connected_audience_attending")

cormat_df_live.long<-cormat_df_live.long%>%select(-group)

cormat_df_live.wide<-pivot_wider(cormat_df_live.long, names_from = var, values_from = response)
```

```{r}
colnames(cormat_df_live.wide)
```

```{r}
# rename the vars so they appear pretty in the chart
colnames(cormat_df_live.wide)<-c("Pt_ID", "piece", "Absorption","Distracted","Attention Others", "Attention Sensations", "Positive Transformation", "Negative Transformation", "Own World","Daydream", "Kama Muta","Awe", "Connected Musicians", "Connected Audience","Familiar","Enjoyment")

cor_df<-cormat_df_live.wide%>%dplyr::select(-Pt_ID, -piece)
  
variables<-c("Absorption","Distracted","Attention Others", "Attention Sensations", "Positive Transformation", "Negative Transformation", "Own World","Daydream", "Kama Muta","Awe", "Connected Musicians", "Connected Audience","Familiar","Enjoyment")

rmc_mat<-rmcorr_mat(Pt_ID, variables, cormat_df_live.wide, CI.level = 0.95)

# create corrected p-values (correction = FDR adjustment)
correlation_fdr = rm_adjusted.corr(rmc_mat, cor_df, p.adjust = TRUE, p.adjust.method = "fdr", threshold = 0.05, cor.method = "repeated")

Title = "Correlation Matrix: Live"

colours_blue_white_red<-c("#2d769a", "white","#b34036") # update colors as you wish

Subtitle = "Repeated Measures Correlations - FDR Adjusted"
rm_correlation.matrix(correlation_fdr, colours_blue_white_red, Title, Subtitle)
graphname<-paste0("../revised_plots/RM_Correlations_live.png")

ggsave(graphname, width = 12, height = 10, units = 'cm', dpi = 500)
```

#### Livestreaming
```{r}
cormat_df<-df.full%>%select(Pt_ID,group,contains("mus_abs"), contains(attention_items), contains(transformation_items),contains(daydream_items), contains("KM"), contains("AWE_wonder"), contains("connected_musicians"), contains("connected_audience"), contains("familiar"),contains("enjoy")) 

cormat_df_livestreaming<-cormat_df%>%filter(group == "Virtual")

cormat_df_livestreaming.long<-cormat_df_livestreaming%>%pivot_longer(!c(Pt_ID,group),
                        names_to = c("var", "piece"),
                        names_pattern ="(.*)_(.*)",
                        values_to = "response")

cormat_df_livestreaming.long<-cormat_df_livestreaming.long%>%filter(var != "connected_audience_streaming", var != "connected_audience_attending")

cormat_df_livestreaming.long<-cormat_df_livestreaming.long%>%select(-group)

cormat_df_livestream.wide<-pivot_wider(cormat_df_livestreaming.long, names_from = var, values_from = response)
```

```{r}
colnames(cormat_df_livestream.wide)
```

```{r}
# rename the vars so they appear pretty in the chart
colnames(cormat_df_livestream.wide)<-c("Pt_ID", "piece", "Absorption","Distracted","Attention Others", "Attention Sensations", "Positive Transformation", "Negative Transformation", "Own World","Daydream", "Kama Muta","Awe", "Connected Musicians", "Connected Audience","Familiar","Enjoyment")

cor_df<-cormat_df_livestream.wide%>%dplyr::select(-Pt_ID, -piece)
  
variables<-c("Absorption","Distracted","Attention Others", "Attention Sensations", "Positive Transformation", "Negative Transformation", "Own World","Daydream", "Kama Muta","Awe", "Connected Musicians", "Connected Audience","Familiar","Enjoyment")

rmc_mat<-rmcorr_mat(Pt_ID, variables, cormat_df_livestream.wide, CI.level = 0.95)

# create corrected p-values (correction = FDR adjustment)
correlation_fdr = rm_adjusted.corr(rmc_mat, cor_df, p.adjust = TRUE, p.adjust.method = "fdr", threshold = 0.05, cor.method = "repeated")

Title = "Correlation Matrix: Livestreaming"

colours_blue_white_red<-c("#2d769a", "white","#b34036") # update colors as you wish

Subtitle = "Repeated Measures Correlations - FDR Adjusted"
rm_correlation.matrix(correlation_fdr, colours_blue_white_red, Title, Subtitle)
graphname<-paste0("../revised_plots/RM_Correlations_livestreaming.png")

ggsave(graphname, width = 12, height = 10, units = 'cm', dpi = 500)
```

#### AIMS and Awe
In related research: Trait-based measures of absorption predict awe and instructing people to be absorbed in their experience also increases the experience of awe (van Elk et al., 2016).
Therefore, check whether AIMS predicted AWE. 
First try separate linear models.
```{r}
# get data
df_awe_aims<-df.full%>%select(Pt_ID, AIMS, group, contains("AWE"))

# make long
df_awe_aims.long<-df_awe_aims%>%pivot_longer(!c(Pt_ID, AIMS, group), #make long
                            names_to = c("var", "piece"),
                            names_pattern ="(.*)_(.*)",
                            values_to = "response")

df_awe_aims.wide<-df_awe_aims.long%>%pivot_wider(names_from = var, values_from = response)

df_awe_aims.wide$piece<-factor(df_awe_aims.wide$piece, levels = c("Beethoven", "Schnittke", "Bach", "Folk"))
#factor for the correct facet order

df_awe_aims.wide_nona<-df_awe_aims.wide%>%drop_na() #408 to 351
```

```{r}
baseline_awe<-lmer(AWE_wonder ~ 1 + (1|Pt_ID), data = df_awe_aims.wide_nona, REML = FALSE)
awe_aims<-lmer(AWE_wonder ~ AIMS + (1|Pt_ID), data = df_awe_aims.wide_nona, REML = FALSE)

anova(baseline_awe, awe_aims)
```

```{r}
summary(awe_aims)
```

Check assumptions
```{r}
plot(awe_aims)

#### QQPlot
ggqqplot(df_awe_aims.wide_nona, "AWE_wonder", ggtheme = theme_bw()) +
  facet_grid(piece ~ group)
```

Visualize the relation: Included in the supplementary material: figure 3
```{r}
title =  "Awe & AIMS"

# r
# p<-df_awe_aims.wide%>% 
#   ggplot(aes(x = AIMS, y = AWE_wonder))+
#   geom_point(alpha = .5)+
#   labs(title =title,x = "AIMS", y = "Awe")+
#   geom_smooth(method = lm)+
#   facet_grid(rows = vars(piece), cols = vars(group))+
#   theme_minimal()+
#   stat_cor(aes(label = ..r.label..), color = "blue", geom = "label") 

p<-df_awe_aims.wide%>% 
  ggplot(aes(x = AIMS, y = AWE_wonder))+
  geom_point(alpha = .5)+
  labs(title =title,x = "AIMS", y = "Awe")+
  geom_smooth(method = lm)+
  #facet_grid(rows = vars(piece), cols = vars(group))+
  theme_minimal()+
  stat_cor(aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~")), color = "blue", geom = "label")

p

graphname<-paste0("../revised_plots/", title,".png")
ggsave(graphname, width = 15, height = 10, units = 'cm', dpi = 500)
```

## 3.3.3 Familiarity, Enjoyment, and Absorption

```{r}
df_famil_enjoy<-df.full%>%select("Pt_ID", contains(c("familiar", "enjoy", "mus_abs")))%>%select(!familiar_Bach)

df_famil_enjoy.long<-df_famil_enjoy%>%pivot_longer(!Pt_ID,
                        names_to = c("question", "piece"),
                        names_pattern ="(.*)_(.*)",
                        values_to = "response")

df_famil_enjoy.wide<-df_famil_enjoy.long%>%pivot_wider(names_from = question, values_from = response)

describe(df_famil_enjoy.wide)
```

#### Familiarity
Being familiar with the music was positively correlated with absorption (r = .21, p = .001).

```{r}
fam_abs.rmc<-rmcorr(participant = "Pt_ID", measure1 = "familiar", measure2 = "mus_abs", dataset = df_famil_enjoy.wide)
fam_abs.rmc

plot(fam_abs.rmc, absorbed_factors, lty = 2)
```

#### Enjoyment

Enjoying the music was positively correlated with absorption (r = .61, p < .001). Recall that this result is simply correlational and not causational so there is no way to know whether enjoyment leads to better absorption or if absorption leads to enjoyment.

```{r}
enj_abs.rmc<-rmcorr(participant = "Pt_ID", measure1 = "enjoy", measure2 = "mus_abs", dataset = df_famil_enjoy.wide)
enj_abs.rmc

plot(enj_abs.rmc, absorbed_factors, lty = 2)
```

# 3.4 Personal Characteristics and Absorption
2. What is the impact of previous musical training/acquaintance with the performed music/personal relation to the DSQ on absorption?

Personal Characteristics (EC, AIMS, Musician, Relationship, Fan) x Absorption

(Musical training, Acquaintance/familiarity with music, personal relations to the performers, empathy)

Use a multiple regression approach to assess which variables predict absorption. 

Average absorption over the three pieces because personal characteristics are the same across pieces. 

What is the relation between absorption and traits?
* Empathic concern
* AIMS
* Musician Status
* Personal Relation to the Performers
* Fan status
```{r}
personal_variables<-c("EC", "AIMS", "musician_status", "personal_relation", "fan")

df_personal<-df.full%>%select(Pt_ID,group,all_of(personal_variables))

describe(df_personal)
```

```{r}
# average the absorption factors across all 3 pieces.
absorbed_mean<-musical_absorption.long%>%group_by(Pt_ID)%>%summarise(absorb_mean = mean(response))

df_personal_abs<-full_join(df_personal, absorbed_mean, by = c("Pt_ID"))

df_personal_abs_std<-standardize(df_personal_abs)
```

## Regression
DV: absorption (continuous)

IV: personal characteristics Continuous: EC, AIMS Ordinal: musician_status, fan Categorical: personal_relation

Multiple regression notes from the textbook (Field) The more predictors you add, the higher R^2 will be (explantory power of the model). Therefore the Aikake Information Criterion (AIC) is a better measure of the fit of a model. It penalizes extra predictors. (A little like adjusted R^2). The higher the AIC, the worse the model fit is. AIC can be used to compare models with the same outcome measure.

Care should be taken when selecting which predictors to be entered in the model. When predictors are all completely uncorrelated, then the order of entry into the model doesn’t matter as much. However there are rarely uncorrelated predictors.

Choosing parameter and their order: - Hierarchical: predictors are selected based on past research and the experimenter decides how to add them to the model, in order of importance of the predictor based on past research. New predictors suspected to be the most important should be entered first. - Forced entry: all predictors are added without consideration for order. - Stepwise: R mathematically assesses whether the addition of a predictor contributed to better fit or not with the AIC. The backwards selection approach leads to less suppressor effects than the forward selection approach so it should be favoured. However generally statisticians frown upon stepwise regression approaches. - All subsets method: tests all combinations of the predictors. With 6 variables, it will be 64 combinations (2**6). This shouldn’t be too computationally intensive.

What method to choose? Use theoretical literature to include meaningful variables in their order of importance first, then repeat the regression, but exclude variables that were statistically redundant the first time.

#### Step 1: Think critically about the variables and what would be most likely to influence absorption.

The AIMS should be the variable that most influences a propensity to be absorbed (because that is exactly what it is supposed to measure). Then fan-status is likely to be important for fostering feelings of absorption, based on my own musical experiences. I would not know what would be most important between EC, musician status, and personal relation. Perhaps one approach would be to examine the correlations.

#### Step 2: Correlations

Interestingly, the correlation indicates that fan-status may actually be more related to participants' experiences of absorption than AIMS.

```{r}
cor_df_personal_chars<-df_personal_abs%>%select(-Pt_ID, -musician_status, -personal_relation, -group)
cor.plot(cor_df_personal_chars, numbers = TRUE)

cor_df_personal_chars_std<-df_personal_abs_std%>%select(-Pt_ID, -musician_status, -personal_relation, -group)
cor.plot(cor_df_personal_chars_std, numbers = TRUE)
```

#### Step 3: Make the model

##### Set the categorical contrasts

```{r}
# Musician Status
summary(df_personal_abs$musician_status)

contrasts(df_personal_abs$musician_status)<-contr.treatment(7, base = 1)
#Baseline: tone-deaf. there is only one tone-deaf person though so maybe we should change the baseline to the group with the most number of people (3)
#df_personal_abs$musician_status # execute this to check contrasts. 

# Personal Relation
summary(df_personal_abs$personal_relation)

contrasts(df_personal_abs$personal_relation)<-contr.treatment(2, base = 1)
#Baseline: no personal relation
#df_personal_abs$personal_relation # execute this to check contrasts. 
```

##### Model
```{r}
m1<-lm(absorb_mean ~ AIMS + fan, data = df_personal_abs)
summary(m1) # Adjusted R-Squared = .27

m1_std<-lm(absorb_mean ~ AIMS + fan, data = df_personal_abs_std)
summary(m1_std) # Adjusted R-Squared = .27 (stadnrdizing made no difference! phewf!)

m2<-update(m1, .~. + personal_relation + musician_status + EC)
summary(m2)

m2_std<-update(m1_std, .~. + personal_relation + musician_status + EC)
summary(m2_std)

# musician status and personal relation are having little to no effect

m3<-update(m1, .~. + personal_relation)
summary(m3)

# confirmed: personal_relation has no effect

m4<-update(m1, .~. + musician_status)
summary(m4)

# try with musical non-musician as baseline.
contrasts(df_personal_abs$musician_status)<-contr.treatment(7, base = 3)
m5<-update(m1, .~. + musician_status)
summary(m5) # still no sig differences between the musician status groups

m6<-update(m1, .~. + EC)
summary(m6) # empathic concern is only trending as a predictor for absorption # Adjusted R-Squared = .28
```

### Rebuild model to make sure there are the correct number of df

```{r}
df_aims_fan<-df_personal_abs%>%select(Pt_ID,group, AIMS, fan, absorb_mean)

df_aims_fan%>%filter(!is.na(absorb_mean))%>%group_by(group)%>%summarise(n())

df_aims_fan_nona<-df_aims_fan%>%filter(!is.na(absorb_mean))

# i actually need to remove na from AIMS and fan as well I think.
df_aims_fan_nona<-df_aims_fan%>%filter(!is.na(absorb_mean))%>%filter(!is.na(AIMS))%>%filter(!is.na(fan))

m1<-lm(absorb_mean ~ AIMS + fan, data = df_aims_fan_nona)
summary(m1) # Adjusted R-Squared = .27

```

M1 is probably the best model. I should check AIC anyways to check whether including EC does contribute even though it isn’t significant.

```{r}
anova(m1, m6)
# Model 6 is not better than model 1. 
```

```{r}
# Since EC was a trending predictor when added to M1, what happens if you make a model with only fan and EC
m7<-lm(absorb_mean ~ fan + EC, data = df_personal_abs)
summary(m7) 

# now EC is a significant predictor

## what happens if AIMS is added after EC
m8<-lm(absorb_mean ~ fan + EC + AIMS, data = df_personal_abs)
summary(m8) 

# With AIMS added after EC, EC is no longer significant and AIMS is only trending. But then 28% of the variance is explained.
```

#### Step 4: Assess the model
Assess the model to see if there are any influential cases affecting the model.

```{r}
df_personal_abs_modelStats<-df_personal_abs%>%select(-personal_relation, -musician_status, -EC)%>%drop_na()

m1_modelStats<-data.frame(resid(m1), rstandard(m1))

df_personal_abs_modelStats$residuals<-resid(m1)
df_personal_abs_modelStats$standardized.residuals<- rstandard(m1)
df_personal_abs_modelStats$studentized.residuals<-rstudent(m1)
df_personal_abs_modelStats$cooks.distance<-cooks.distance(m1)
df_personal_abs_modelStats$dfbeta<-dfbeta(m1)
df_personal_abs_modelStats$dffit<-dffits(m1)
df_personal_abs_modelStats$leverage<-hatvalues(m1)
df_personal_abs_modelStats$covar.ratios<-covratio(m1)

df_personal_abs_modelStats$large.residual<-df_personal_abs_modelStats$standardized.residuals>2 | df_personal_abs_modelStats$standardized.residuals< -2
sum(df_personal_abs_modelStats$large.residual) #102 observations and 4 have large residuals. expected: 5%

df_personal_abs_modelStats[df_personal_abs_modelStats$large.residual, c("cooks.distance", "leverage", "covar.ratios")]

# Cook's distance is no where above 1. Therefore none of them is having an undue influence on the model.

# Leverage is calculated as (k+1)/n where k is the number of IV and n is number of observations therefore average leverage is 3/98 = .03. Then items that are 2 to 3 x the leverage should be flagged, but none of them are over .06.

# Covariance ratio needs to be within certain bounds. Specifically, 
# CVRi > 1 + [3(k + 1)/n] = 1 + [3(2 + 1)/98] = 1.09;
# CVRi < 1 – [3(k + 1)/n] = 1 – [3(2 + 1)/98] = 0.91.
# ADQ056 has a low covariance ratio, but the cook's distance is not alarming, therefore we don't need to worry about the low covariance so much
```

#### Step 5: Assumptions  
Check whether the model meets model assumptions. From section 7.9.3 in the textbook:

##### Independence Assumption   
Assessing the assumption of independence: Durbin Watson Test The D-W statistic should be close to 2 and if it approaches 1 or 3 that would indicate a bad result.

```{r}
durbinWatsonTest(m1)
```

##### Assumption of no Multicollinearity   
Assessing the assumption of no Multicollinearity

```{r}
vif(m1) #tolerance = 1/vif

1/vif(m1)

mean(vif(m1))

```

If the largest VIF is over 10, this is problematic. If the average VIF is substantially over 1, then the model may be biased. Tolerance below 0.1 indicates a serious problem and below 0.2 indicates a potential problem.Therefore this looks good.

##### Assumptions about the residuals   
Can be examined visually

```{r}
plot(m1)
```

```{r}
# residuals vs fitted plot looks good. no evidence of heteroscedasticity or nonlinearity.
# QQplot shows little to no deviations from normality

hist(df_personal_abs_modelStats$studentized.residuals)

# looks pretty normal
```

### Summary

The model appears to be both accurate for the sample and generalizable to the population.

The best model for explaining the influence of individual characteristics on absorption contains AIMS and fan-status as significant predictors. Together they explain 27% of the variance. The AIMS is a personality scale that measures participants’ typical absorption with music. Fan-status was an even stronger predictor of absorption than AIMS.

```{r}
summary(m1)
# 107 observations and 5 observations deleted due to missingness (in the predictor variables rather than the absorption variable)
confint(m1, level = .95)
```

```{r}
df_aims_fan_nona%>%group_by(group)%>%summarise(n())
```
### Visualize the regression model
```{r}
df_aims_fan_nona.long<-df_aims_fan_nona%>%pivot_longer(c(fan, AIMS), names_to = "variable")
df_aims_fan_nona.long$variable<-factor(df_aims_fan_nona.long$variable, levels = c("fan", "AIMS"), labels = c("Fanship", "AIMS"))

# this vis looks best to me. 
df_aims_fan_nona.long%>%
  ggplot(aes(x = value, y = absorb_mean))+
  facet_grid(cols = vars(variable), scales = "free")+
  geom_point(alpha = .5)+
  geom_smooth(method = "lm")+
  labs(title = "Fanship and AIMS on Musical Absorption", x = "", y = "Absorption (mean of all pieces)")+
  theme_minimal()+
  stat_cor(aes(label = ..r.label..), label.x.npc = .17,label.y.npc = .95, color = "blue", geom = "label")

graphname<-paste0("../revised_plots/Fanship_aims_absorb.png")
ggsave(graphname, width = 15, height = 8, units = 'cm', dpi = 500)

graphname<-paste0("../revised_plots/Publication_Figures/Fanship_aims_absorb.jpg")
ggsave(graphname, width = 15, height = 8, units = 'cm', dpi = 500, bg = "white")
```


# 3.5.1 Absorption ~ Group + Piece
3.5 What is the influence of social context (group: Live, Livestreaming) and the piece of music (Beethoven, Schnittke, Folk) on musical absorption and mind-wandering?

```{r}
dat<-df.full%>%select(Pt_ID, group,contains("mus_abs"))

df.long<-dat%>%pivot_longer(!c(group, Pt_ID), #make long
                            names_to = c("piece"),
                            names_pattern ="mus_abs_(.*)",
                            values_to = "Absorption")

df.long$piece<-factor(df.long$piece, levels = c("Beethoven", "Schnittke", "Folk"))
#factor for the correct facet order

data<-df.long%>%drop_na() #408 to 368

data%>%group_by(group, piece)%>%summarize(n())
```


IV1: group, IV2: piece, DV: Absorption factor score 
```{r}
data %>%
  group_by(group, piece) %>%
  get_summary_stats(Absorption, type = "mean_sd")

bxp <- ggboxplot(
  data, x = "piece", y = "Absorption",
  color = "group", palette = "jco"
  )
bxp
```
### Outliers
ADQ003 is an outlier, though not extreme
```{r}
outliers<-data %>%
  group_by(group, piece) %>%
  identify_outliers(Absorption)

outliers
```
There were no extreme outliers and this outlier appears to be a real result and not an error of data entry.


### LME4
 lme4 handles  uneven sample sizes better than mixed ANOVAs
```{r}
baseline<-lmer(Absorption ~ 1 +(1|Pt_ID), data = data, REML = FALSE) 
groupM<-lmer(Absorption ~ 1 + group + (1|Pt_ID), data = data, REML = FALSE)  
anova(baseline, groupM) # sig effect group, p = .0132

pieceM<-lmer(Absorption ~ 1 + piece + (1|Pt_ID), data = data, REML = FALSE) 
anova(baseline, pieceM) # sig. p = .0018 

piece_groupM<-lmer(Absorption ~ 1 + piece + group + (1|Pt_ID), data = data, REML = FALSE) 
anova(baseline, pieceM, piece_groupM) # sig effect of group even when accounting for effect of piece p =.016

piece_x_groupM<-lmer(Absorption ~ 1 + piece * group + (1|Pt_ID), data = data, REML = FALSE) 
anova(baseline, pieceM, piece_groupM, piece_x_groupM) # no interaction between group and piece p = .49
```

There were significant effects of piece and group. 

Report estimates and variance with REML
```{r}
piece_groupM<-lmer(Absorption ~ 1 + piece + group + (1|Pt_ID), data = data, REML = FALSE) 
summary(piece_groupM)

piece_groupM_reml<-lmer(Absorption ~ 1 + piece + group + (1|Pt_ID), data = data, REML = TRUE) 
summary(piece_groupM_reml)
```
Results are only very sligthly different between REML = FALSE and REML = TRUE. 

## Post-hoc testing
```{r}
estimate_means(piece_groupM, at = "piece")
estimate_contrasts(piece_groupM, contrast = "piece")

estimate_means(piece_groupM, at = "group")
estimate_contrasts(piece_groupM, contrast = "group")
```

### Check assumptions
*Linearity*
Because there is no obvious pattern in the residuals, it seems like there is no violation of the linearity assumption.
```{r}
plot(fitted(piece_groupM),residuals(piece_groupM))
```

*Absence of Collinearity*
If two fixed effects predictors are correlated with each other, they are said to be collinear. 

They can't be correlated because they are both factors.

*Homoskedasticity*
This doesn't appear obviously heteroscedastic but it isn't perfect either. 
We can check with Levene's test for checking variance across groups
```{r}
leveneTest(data$Absorption, data$group, center = mean) # variance is not different across groups.
```
*Normality of residuals* 
"The	 normality	 of	 residuals	 assumption	 is	 the	 one	 that	 is	 least	 important.	
Interestingly,	many	people	seem	to	think	it	is	the	most	important	one,	but	it	turns	
out	that	linear	models	are	relatively	robust	against	violations	of	the	assumptions	
of	normality.	Researchers	differ	with	respect	to	how	much	weight	they	put	onto	
checking	this	assumption.	For	example,	Gellman	and	Hill	(2007),	a	 famous	book
on	linear	models	and	mixed	models,	do	not	even	recommend	diagnostics	of	the	
normality	assumption	(ibid.	46)."

Therefore, it may be ok to violate this assumption.

```{r}
hist(residuals(piece_groupM)) #  not bad. slight negative tail.

qqnorm(residuals(piece_groupM)) # slight skew

require(lattice)
qqmath(piece_groupM, id=0.05) #id: identifies values that may be exerting undue influence on the model (i.e. outliers
```
### Visualize
```{r}
colours_DSQ<-c("#2d769a","#b34036")

#update group label
data$group<-factor(data$group, levels = c("Live", "Virtual"), labels = c("Live", "Livestreaming"))
```


```{r}
plot_dat<-data%>%group_by(group, piece)%>%summarise(mean = mean(Absorption), se = sd(Absorption)/sqrt(n()))

ggplot(plot_dat, aes(x = piece))+
    geom_errorbar(aes(y = mean, color = group, ymin=mean-se, ymax=mean+se), width=.1, show.legend = FALSE)+
    geom_line(aes(y = mean, color = group, group = group, linetype = group)) +
    geom_point(aes( y = mean, color = group))+
    geom_point(data = data, aes(height = .5, width = .5, x = piece, y = Absorption, color = group), alpha = .15, position = position_jitterdodge())+
    scale_linetype_manual(values = c("solid", "dashed"))+
    scale_color_manual(values = colours_DSQ)+
    theme_minimal()+theme(legend.key.width = unit(.4, "in"))+
    labs(x = "Piece", y = "Absorption", title = "Effect of Piece and Group on Absorption", linetype = "Concert Group", color = "Concert Group")

graphname<-paste0("../revised_plots/Publication_Figures/Absorption-piece_group_line.jpg")
ggsave(graphname, width = 17, height = 10, units = 'cm', dpi = 500, bg= "white")
```


## Check if fanship could actually be accounting for the differences more than the group.
Because there was a group difference in fanship therefore this could be a confounding variable.

```{r}
dat<-df.full%>%select(Pt_ID, group,contains("mus_abs"), fan)

df.long<-dat%>%pivot_longer(!c(group, Pt_ID, fan), #make long
                            names_to = c("piece"),
                            names_pattern ="mus_abs_(.*)",
                            values_to = "Absorption")

df.long$piece<-factor(df.long$piece, levels = c("Beethoven", "Schnittke", "Bach", "Folk"))
#factor for the correct facet order

data<-df.long%>%drop_na() #408 to 341

data%>%group_by(group, piece)%>%summarize(n())
```

```{r}
# recheck the model with this new data
baseline<-lmer(Absorption ~ 1 + (1|Pt_ID), data = data, REML = FALSE) 
pieceM<-lmer(Absorption ~ 1 + piece + (1|Pt_ID), data = data, REML = FALSE) 
piece_groupM<-lmer(Absorption ~ 1 + piece + group + (1|Pt_ID), data = data, REML = FALSE) 
piece_group_fanM<-lmer(Absorption ~ 1 + piece + group + fan + (1|Pt_ID), data = data, REML = FALSE) # sig effect of fan
piece_group_x_fanM<-lmer(Absorption ~ 1 + piece + group * fan + (1|Pt_ID), data = data, REML = FALSE) #trending
piece_x_group_fanM<-lmer(Absorption ~ 1 + piece* fan + group + (1|Pt_ID), data = data, REML = FALSE) #NS
anova(baseline, pieceM, piece_groupM, piece_group_fanM,piece_x_group_fanM)
anova(baseline, pieceM, piece_groupM, piece_group_fanM,piece_group_x_fanM)

#refit with reml
piece_group_fanM_reml<-lmer(Absorption ~ 1 + piece + group + fan + (1|Pt_ID), data = data, REML = TRUE) # sig effect of fan
summary(piece_group_fanM_reml)
```

```{r}
estimate_means(piece_group_fanM, at = "piece")
estimate_contrasts(piece_group_fanM, contrast = "piece")

estimate_means(piece_group_fanM, at = "group")
estimate_contrasts(piece_group_fanM, contrast = "group")
```



# 3.6 Absorption & motion (and piece and group)
What is the relation between absorption and motion?

Useful tutorial about lme and fixed and random effects provided by Jonna: https://psyteachr.github.io/stat-models-v1/linear-mixed-effects-models-with-one-random-factor.html

## 3.6.1 LME with Quantity of Motion (QoM) & Absorption
```{r}
dat<-df.full%>%select(Pt_ID, group,contains("mus_abs"), contains("QoM"))

df.long<-dat%>%pivot_longer(!c(group, Pt_ID), #make long
                            names_to = c("var", "piece"),
                            names_pattern ="(.*)_(.*)",
                            values_to = "response")

# remove Bach
df.long<-df.long%>%filter(! piece == "Bach")

df.wide<-df.long%>%pivot_wider(names_from = var, values_from = response)

df.wide$piece<-factor(df.wide$piece, levels = c("Beethoven", "Schnittke", "Folk"))
#factor for the correct facet order

# note df.wide is the same as data including NA
df.wide%<>%rename("Absorption" = "mus_abs")

data<-df.wide%>%drop_na() #408 to 293
```


### Remove extreme outliers
#### Absorption
```{r}
outliers<-data %>%
  group_by(group, piece) %>%
  identify_outliers(Absorption)

outliers # 1; None are extreme.

extreme<-outliers%>%filter(is.extreme == TRUE)

extreme # none are extreme

# remove specific instances that are outliers (Pt_ID and piece, because lme can handle missing data so you don't need to remove the whole participant)

# data uten outliers
data_u_outliers<-data%>% # 293 to 292 : looks good!
  group_by(group, piece) %>%
  filter(!is_outlier(Absorption))%>%
  ungroup()

# data uten extreme  
data_u_extreme<-data%>% # 293 to 293 : looks good!
  group_by(group, piece) %>%
  filter(!is_extreme(Absorption))%>%
  ungroup()
```

#### QoM
```{r}
outliers<-data %>%
  group_by(group, piece) %>%
  identify_outliers(mQoM)

outliers # 21 

extreme_outliers<- outliers%>%filter(is.extreme == TRUE)

extreme_outliers # 6 instances

data_u_outliers<-data_u_outliers%>% # 293 to 272
  group_by(group, piece) %>%
  filter(!is_outlier(mQoM))%>%
  ungroup()
  
data_u_extreme<-data_u_extreme%>% # 293 to 287 : looks good!
  group_by(group, piece) %>%
  filter(!is_extreme(mQoM))%>%
  ungroup()
```

```{r}
data_u_extreme%>%group_by(group, piece)%>%summarise(n())
```


### Test 

#### Individual effects of group, piece, mQoM
What are the individual effects of group, piece, mQoM?

This model should be built to only show the additional contribution of mQoM and its interactions with piece and group, with a random intercept and slope of participant.

There was a significant main effect of piece,  χ2(2) = 6.47, p = 0.039, but no significant main effect of group, χ2(1) = 2.59, p = 0.11, or quantity of motion, χ2(1) = 1.08, p = 0.30. Importantly, there was a significant interaction between motion and group, χ2(2) = 10.49, p = 0.0012, however there was no significant interaction of piece with motion,  χ2(2) = 2,84, p = 0.24.  The three-way interaction between motion, group, and piece was not significant either, χ2(2) = .51, p = 0.76.

```{r}
baseline<-lmer(Absorption ~ 1 +(1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE) 
groupM<-lmer(Absorption ~ 1 + group + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE)  
anova(baseline, groupM) # NS

pieceM<-lmer(Absorption ~ 1 + piece + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE) 
anova(baseline, pieceM) # sig p =.039

qomM<-lmer(Absorption ~ 1 + mQoM + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE) 
anova(baseline, qomM) # NS
```

#### Model fitting
```{r}
# Baseline model
baseline<-lmer(Absorption ~ 1 + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE) 
pieceM<-lmer(Absorption ~ 1 + piece + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE) 
anova(baseline, pieceM) # Sig effect of piece. p = .039

# effect of group
pieceM<-lmer(Absorption ~ 1 + piece + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE) # boundary warning
piece_group<-lmer(Absorption ~ 1 + group + piece + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE)
anova(pieceM, piece_group) # trending effect of group (p = .0586). but not significant with this subset of data (so few data points).

## no random slope comparison - more sig without random slope
pieceM_nors<-lmer(Absorption ~ 1 + piece + (1|Pt_ID), data = data_u_extreme, REML = FALSE)
piece_group_nors<-lmer(Absorption ~ 1 + group + piece + (1|Pt_ID), data = data_u_extreme, REML = FALSE)
anova(pieceM_nors, piece_group_nors) # p = .023; more sig effect of group without random slope (p = .02)

# interaction group and piece: NS
piece_group<-lmer(Absorption ~ 1 + group + piece + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE)
pieceXgroup<-lmer(Absorption ~ 1 + group*piece + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE) # boundary warning and model failed to converge
anova(piece_group, pieceXgroup) # NS-  the interaction does not add more than the main effects

# effect of motion
pieceM<-lmer(Absorption ~ 1 + piece + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE)
piece_qomM<-lmer(Absorption ~ 1 + piece + mQoM + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE) 
anova(pieceM, piece_qomM) # NS - adding QoM NS. what about interactions?

# interaction piece and motion
piece_x_qomM<-lmer(Absorption ~ 1 + piece*mQoM + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE) 
anova(piece_qomM, piece_x_qomM) # NS - adding QoM x piece interaction NS. 

# main effect piece and interaction between group and motion
piece_group<-lmer(Absorption ~ 1 + group + piece + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE)
group_piece_qomM<-lmer(Absorption ~ 1 + group + piece + mQoM + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE) # the effect of 
anova(piece_group,group_piece_qomM) # adding qom is not sig therefore I am not sure I am allowed to add interactions?

piece_group_x_qomM<-lmer(Absorption ~ 1 + piece + group*mQoM + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE)  
anova(group_piece_qomM, piece_group_x_qomM) # Significant: there is added benefit of adding the interaction with qom and group.  # RESULT REPORTED IN MS
anova(pieceM, piece_group_x_qomM) # and this is also true even when it is compared against the simpler piece only model as well.

group_piece_x_qomM<-lmer(Absorption ~ 1 + group+piece*mQoM + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE)  # boundary warning
anova(group_piece_qomM, group_piece_x_qomM)

# other models
piece_x_group_group_x_qomM<-lmer(Absorption ~ 1 + piece*group + group*mQoM + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE)
anova(piece_group_x_qomM, piece_x_group_group_x_qomM) # ns - no benefit of adding interaction of piece and group

# no sig 3-way
qomM_x_piece_x_group<-lmer(Absorption ~ 1 + mQoM*group*piece + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE) 
anova(piece_group_x_qomM, qomM_x_piece_x_group) # NS - no 3-way interaction

anova(baseline, pieceM,piece_group,group_piece_qomM, piece_group_x_qomM) # sig
anova(baseline, pieceM,piece_group,piece_group_x_qomM) # sig even if comparing just with the main effects of piece and group.

# no sig interaction of piece with motion
piece_x_qom_group_x_qomM<-lmer(Absorption ~ 1 + piece*mQoM + group*mQoM + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE) # boundary warning
anova(piece_group_x_qomM, piece_x_qom_group_x_qomM)

# no sig interction of piece with group
piece_x_qom_group_x_qomM_group_x_piece<-lmer(Absorption ~ 1 + piece*group + piece*mQoM + group*mQoM + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE) # boundary warning

# no sig 3-way
qomM_x_piece_x_group<-lmer(Absorption ~ 1 + mQoM*group*piece + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE) # boundary warning

anova(baseline, pieceM,piece_group,group_piece_qomM, piece_group_x_qomM, piece_x_qom_group_x_qomM, piece_x_qom_group_x_qomM_group_x_piece, qomM_x_piece_x_group) 
```

```{r}
## no random slope comparison. - it is more sig with the random slope of qom
baseline<-lmer(Absorption ~ 1 + (1|Pt_ID), data = data_u_extreme, REML = FALSE) 
pieceM<-lmer(Absorption ~ 1 + piece + (1|Pt_ID), data = data_u_extreme, REML = FALSE)
anova(baseline, pieceM)

## comparison with full dataset. more significant with full dataset
baseline<-lmer(Absorption ~ 1 + (1+mQoM|Pt_ID), data = data, REML = FALSE) 
pieceM<-lmer(Absorption ~ 1 + piece + (1+mQoM|Pt_ID), data = data, REML = FALSE)
anova(baseline, pieceM)
data%>%group_by(piece)%>%summarize(n())

```

Report parameter estimates with REML
```{r}
piece_group_x_qomM<-lmer(Absorption ~ 1 + piece + group*mQoM + (1+mQoM|Pt_ID), data = data_u_extreme, REML = TRUE)  
summary(piece_group_x_qomM)
```

```{r}
plot(piece_group_x_qomM)
summary(piece_group_x_qomM)
```

check model parameter estimates to understnad the intraction between group and motion on absorption

```{r}
plot(parameters(piece_group_x_qomM))
```

```{r}
slopes<-estimate_slopes(piece_group_x_qomM, trend = "mQoM", at = "group")

plot(slopes)
```

```{r}
slopes
```
```{r}
estimate_contrasts(piece_group_x_qomM, at = "mQoM", contrast = "group")
```


#### Refit with REML to report those variance estimates
From: https://gkhajduk.github.io/2017-03-09-mixed-models/

"Notice that we have fitted our models with REML = FALSE.

REML stands for restricted (or “residual”) maximum likelihood and it is the default parameter estimation criterion for linear mixed models. As you probably guessed, ML stands for maximum likelihood - you can set REML = FALSE in your call to lmer to use ML estimates. However, ML estimates are known to be bias and with REML being usually less bias, REML estimates of variance components are generally preferred. This is why in our previous models we skipped setting REML - we just left it as default (i.e. REML = TRUE).

REML assumes that fixed effects structure is correct. You should use maximum likelihood when comparing models with different fixed effects, as ML doesn’t rely on the coefficients of the fixed effects - and that’s why we are refitting our full and reduced models above with the addition of REML = FALSE in the call.

Even though you use ML to compare models you should **report parameter estimates from your final “best” REML model**, as ML may underestimate variance of the random effects." 

Refitting with REML produces the same results.
```{r}
piece_group_x_qomM<-lmer(Absorption ~ 1 + piece + group*mQoM + (1+mQoM|Pt_ID), data = data_u_extreme, REML = FALSE) 
summary(piece_group_x_qomM)

## Refit with REML
piece_group_x_qomM_reml<-lmer(Absorption ~ 1 + piece + group*mQoM + (1+mQoM|Pt_ID), data = data_u_extreme, REML = TRUE) 
summary(piece_group_x_qomM_reml)
```

```{r}
## fitting with data or df.wide (contains lots of NAs) produce the same results.
piece_group_x_qomM<-lmer(Absorption ~ 1 + piece + group*mQoM + (1+mQoM|Pt_ID), data = data, REML = FALSE)
summary(piece_group_x_qomM)

piece_group_x_qomM<-lmer(Absorption ~ 1 + piece + group*mQoM + (1+mQoM|Pt_ID), data = df.wide, REML = FALSE)
summary(piece_group_x_qomM)
```

#### Check model assumptions

Here is a tutorial that was recommended:
https://bodowinter.com/tutorial/bw_LME_tutorial1.pdf
https://bodowinter.com/tutorial/bw_LME_tutorial2.pdf

*Linearity*
Because there is no obvious pattern in the residuals, it seems like there is no violation of the linearity assumption.
```{r}
plot(fitted(piece_group_x_qomM),residuals(piece_group_x_qomM))
```

*Absence of Collinearity*
If two fixed effects predictors are correlated with each other, they are said to be collinear. 

*Homoskedasticity*
This doesn't appear obviously heteroscedastic but it isn't perfect either. 
We can check with Levene's test for checking variance across groups
```{r}
leveneTest(data_u_extreme$Absorption, data_u_extreme$group, center = mean) # variance is not different across groups.
```
*Normality of residuals* 
"The	 normality	 of	 residuals	 assumption	 is	 the	 one	 that	 is	 least	 important.	
Interestingly,	many	people	seem	to	think	it	is	the	most	important	one,	but	it	turns	
out	that	linear	models	are	relatively	robust	against	violations	of	the	assumptions	
of	normality.	Researchers	differ	with	respect	to	how	much	weight	they	put	onto	
checking	this	assumption.	For	example,	Gellman	and	Hill	(2007),	a	 famous	book
on	linear	models	and	mixed	models,	do	not	even	recommend	diagnostics	of	the	
normality	assumption	(ibid.	46)."

Therefore, it may be ok to violate this assumption.

```{r}
hist(residuals(piece_group_x_qomM)) #  not bad. slight negative tail.

qqnorm(residuals(piece_group_x_qomM)) # slight skew

require(lattice)
qqmath(piece_group_x_qomM, id=0.05) #id: identifies values that may be exerting undue influence on the model (i.e. outliers
```

#### Visualize
Figure 4 in the manuscript
```{r}
#update group label
data_u_extreme$group<-factor(data_u_extreme$group, levels = c("Live", "Virtual"), labels = c("Live", "Livestreaming"))

title =  "Relation between Motion & Absorption"
subtitle= "No Extreme Outliers"

# r
p<-data_u_extreme%>% 
  ggplot(aes(x = mQoM, y = Absorption))+
  geom_point(alpha = .5)+
  labs(title =title,subtitle = subtitle, x = "Mean QoM", y = "Absorption")+
  geom_smooth(method = lm)+
  facet_grid(rows = vars(piece), cols = vars(group))+
  theme_minimal()+
  stat_cor(aes(label = ..r.label..), label.x.npc = .67, color = "blue", geom = "label")#+
  #stat_cor(aes(label = ..rr.label..), label.x.npc = .65, color = "blue", geom = "label")+
  #stat_cor(aes(label = ..rr.label..), label.x.npc = .65, color = "blue", geom = "label")+
  #stat_cor(aes(label = ..r.label..), label.y.npc = .2,label.x.npc = .65, color = "blue", geom = "label")+
  #stat_cor(aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), label.x.npc = .6, color = "blue", geom = "label", size = 2.5)+
  #stat_cor(aes(label = ..r.label..), label.y.npc = .2,label.x.npc = .65, color = "blue", geom = "label", size = 2.5)

p

graphname<-paste0("../revised_plots/", title,subtitle, ".png")
ggsave(graphname, width = 15, height = 10, units = 'cm', dpi = 500)


graphname<-paste0("../revised_plots/Publication_Figures/", title,subtitle, ".jpg")
ggsave(graphname, width = 15, height = 10, units = 'cm', dpi = 500, bg = "white")
```


## 3.6.2 LME with Stilling & Absorption

```{r}
dat<-df.full%>%select(Pt_ID, EC,contains("mus_abs"), contains("Stilling"))%>%select(-Stilling_FullConcert, -Stilling_Bach)

df.long<-dat%>%pivot_longer(!c(EC, Pt_ID), #make long
                            names_to = c("var", "piece"),
                            names_pattern ="(.*)_(.*)",
                            values_to = "response")

df.wide<-df.long%>%pivot_wider(names_from = var, values_from = response)

df.wide$piece<-factor(df.wide$piece, levels = c("Beethoven", "Schnittke", "Bach", "Folk"))
#factor for the correct facet order

df.wide%<>%rename("Absorption" = "mus_abs")

data<-df.wide%>%drop_na() #408 to 233

data%>%group_by(piece)%>%summarise(n())
```

### Remove extreme outliers
#### Absorption
```{r}
outliers<-data %>%
  group_by(piece) %>%
  identify_outliers(Absorption)

outliers # 0; None are extreme.

extreme<-outliers%>%filter(is.extreme == TRUE)

extreme # none are extreme

# remove specific instances that are outliers (Pt_ID and piece, because lme can handle missing data so you don't need to remove the whole participant)

# data uten outliers
data_u_outliers<-data%>% # 233 to 233 : looks good!
  group_by(piece) %>%
  filter(!is_outlier(Absorption))%>%
  ungroup()

# data uten extreme  
data_u_extreme<-data%>% # 233 to 233 : looks good!
  group_by(piece) %>%
  filter(!is_extreme(Absorption))%>%
  ungroup()

```

#### Stilling
```{r}
data%>%summarize(mean = mean(Stilling))

outliers<-data %>%
  group_by(piece) %>%
  identify_outliers(Stilling)

outliers # 3

extreme_outliers<- outliers%>%filter(is.extreme == TRUE)

extreme_outliers # 1

data_u_outliers<-data_u_outliers%>% # 233 to 230
  group_by(piece) %>%
  filter(!is_outlier(Stilling))%>%
  ungroup()
  
data_u_extreme<-data_u_extreme%>% # 233 to 232 : looks good!
  group_by(piece) %>%
  filter(!is_extreme(Stilling))%>%
  ungroup()
```

In the mixed anova we found that piece was a sig predictor of absorption. This was not the case when using lme4. This is probably because there are different sample sizes due to missing data in the stilling and qom measures.
```{r}
# note that these are without random slopes

baseline<-lmer(Absorption ~ 1 +(1|Pt_ID), data = data_u_extreme, REML = FALSE) 
pieceM<-lmer(Absorption ~ 1 + piece + (1|Pt_ID), data = data_u_extreme, REML = FALSE) 
anova(baseline, pieceM) # trending

baseline<-lmer(Absorption ~ 1 +(1|Pt_ID), data = data, REML = FALSE) 
pieceM<-lmer(Absorption ~ 1 + piece + (1|Pt_ID), data = data, REML = FALSE) 
anova(baseline, pieceM) # still only trending
```

#### Random slope Without extreme
Extreme = < Q1 - 3* IQR or > Q3 + 3* IQR
```{r}
baseline<-lmer(Absorption ~ 1 +(1+Stilling|Pt_ID), data = data_u_extreme, REML = FALSE) 
pieceM<-lmer(Absorption ~ 1 + piece + (1+Stilling|Pt_ID), data = data_u_extreme, REML = FALSE) 
stillM<-lmer(Absorption ~ 1 + piece + Stilling + (1+Stilling|Pt_ID), data = data_u_extreme, REML = FALSE) #trending # boundary (singular) fit: see help('isSingular')
intxnM<-lmer(Absorption ~ 1 + piece * Stilling + (1+Stilling|Pt_ID), data = data_u_extreme, REML = FALSE) 
anova(baseline, pieceM, stillM, intxnM) # trending main effect of stilling

stillM<-lmer(Absorption ~ 1 + Stilling + (1+Stilling|Pt_ID), data = data_u_extreme, REML = FALSE)  
anova(baseline, stillM) # trending p = .06
```

Estimate contrasts
```{r}
estimate_slopes(stillM, trend = "Stilling")
```

#### Check model assumptions
Here is a tutorial that was recommended:
https://bodowinter.com/tutorial/bw_LME_tutorial1.pdf
https://bodowinter.com/tutorial/bw_LME_tutorial2.pdf

*Linearity*
Because there is no obvious pattern in the residuals, it seems like there is no violation of the linearity assumption.
```{r}
plot(fitted(pieceM),residuals(pieceM))
plot(fitted(stillM),residuals(stillM))
```

*Absence of Collinearity*
If two fixed effects predictors are correlated with each other, they are said to be collinear. 

*Homoskedasticity*
This doesn't appear obviously heteroscedastic but it isn't perfect either. 

*Normality of residuals* 
"The	 normality	 of	 residuals	 assumption	 is	 the	 one	 that	 is	 least	 important.	
Interestingly,	many	people	seem	to	think	it	is	the	most	important	one,	but	it	turns	
out	that	linear	models	are	relatively	robust	against	violations	of	the	assumptions	
of	normality.	Researchers	differ	with	respect	to	how	much	weight	they	put	onto	
checking	this	assumption.	For	example,	Gellman	and	Hill	(2007),	a	 famous	book
on	linear	models	and	mixed	models,	do	not	even	recommend	diagnostics	of	the	
normality	assumption	(ibid.	46)."

Therefore, it may be ok to violate this assumption.

```{r}
# The histogram looks skewed with a negative tail.
hist(residuals(pieceM)) # still looks slightly skewed

qqnorm(residuals(pieceM))

require(lattice)
qqmath(pieceM, id=0.05) #id: identifies values that may be exerting undue influence on the model (i.e. outliers)

# The histogram looks skewed with a negative tail.
hist(residuals(stillM)) # still looks skewed

qqnorm(residuals(stillM))

qqmath(stillM, id=0.05) #id: identifies values that may be exerting undue influence on the model (i.e. outliers

```

#### Visualize
```{r}
title =  "Relation of Stilling & Absorption"
#subtitle= "No Extreme Outliers"

# r
p<-data%>% 
  ggplot(aes(x = Stilling, y = Absorption))+
  geom_point(alpha = .5)+
  labs(title =title,x = "Stilling", y = "Absorption")+
  geom_smooth(method = lm)+
  facet_grid(rows = vars(piece))+
  theme_minimal()+
  stat_cor(aes(label = ..r.label..), label.x.npc = .2,label.y.npc = .2, color = "blue", geom = "label")#+
  #stat_cor(aes(label = ..rr.label..), label.x.npc = .65, color = "blue", geom = "label")+
  #stat_cor(aes(label = ..rr.label..), label.x.npc = .65, color = "blue", geom = "label")+
  #stat_cor(aes(label = ..r.label..), label.y.npc = .2,label.x.npc = .65, color = "blue", geom = "label")+
  #stat_cor(aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")), label.x.npc = .6, color = "blue", geom = "label", size = 2.5)+
  #stat_cor(aes(label = ..r.label..), label.y.npc = .2,label.x.npc = .65, color = "blue", geom = "label", size = 2.5)

p


graphname<-paste0("../revised_plots/", title, ".png")
ggsave(graphname, width = 15, height = 10, units = 'cm', dpi = 500)

graphname<-paste0("../revised_plots/Publication_Figures/", title, ".jpg")
ggsave(graphname, width = 15, height = 10, units = 'cm', dpi = 500, bg = "white")
```

## 3.6.3 Subjective experience of movement
5. What is the relation between absorption and perceived movement of self and others as well as quantified movement of self and other?

lme4 approach because missing data in some cells is preventing the mixed ANOVA method from working. 

NOTE: the “perceived movement” responses were not continuous, but some were ordinal and some were categorical.Therefore, I should not use methods that rely on continuous data. 

First, I can visualize the relation between absorption and awareness of motion to visually inspect for differences. If none are obvious, there might be no point in conducting a test anyways.

** Questions and Response Options **   
Q1: Were you aware of your physical body during this piece?
Options: Not at all, Rarely, Intermittently, Continuously
Q2: Were you aware of your own physical movement during this piece? If so, how much did you move relative to your own usual behaviour at this kind of concert?
Options: Not aware of movement, Yes and I moved less than usual, Yes and I moved a normal amount, Yes and I moved more than usual
Q3: Were you aware of others in the audience moving during the piece? If so, how much were they moving relative to the usual behaviour you observe at this kind of concert?
Options: Not aware of others’ movement, Yes and they moved less than usual, Yes and they moved a normal amount, Yes and they moved more than usual

```{r}
movement_items<-c(
  "aware_body_Beethoven", 
  "aware_movement_Beethoven", 
  "aware_others_moving_Beethoven",
  "aware_body_Schnittke", 
  "aware_movement_Schnittke", 
  "aware_others_moving_Schnittke",
  "aware_body_Folk", 
  "aware_movement_Folk", 
  "aware_others_moving_Folk")

df_movement<-df.full%>%select("Pt_ID",group, contains(movement_items))

df_move.long<-df_movement%>%pivot_longer(!c(Pt_ID,group), 
                        names_to = c("question", "piece"),
                        names_pattern ="(.*)_(.*)",
                        values_to = "response")

df_move.wide<-df_move.long%>%pivot_wider(names_from = question, values_from = response)
```

*Assign Types*
factor, ordered factor, and numeric
```{r}
# aware body
ordering = c("Not at all","Rarely", "Intermittently", "Continuously") 
## factor
df_move.wide$aware_body_f<-factor(df_move.wide$aware_body, levels = ordering)
## ordered factor
df_move.wide$aware_body_of<-factor(df_move.wide$aware_body, levels = ordering, ordered = TRUE)
## numeric
df_move.wide$aware_body_n<-as.numeric(df_move.wide$aware_body_f)

# aware movement
ordering =c("Not aware of movement","Yes and I moved less than usual", "Yes and I moved a normal amount", "Yes and I moved more than usual")
## factor
df_move.wide$aware_movement_f<- factor(df_move.wide$aware_movement, levels = ordering)
## ordered factor
df_move.wide$aware_movement_of<- factor(df_move.wide$aware_movement, levels = ordering, ordered = TRUE)
## numeric
df_move.wide$aware_movement_n<-as.numeric(df_move.wide$aware_movement_f)

# aware others movement
ordering =c("Not aware of others' movement", "Yes and they moved less than usual", "Yes and they moved a normal amount","Yes and they moved more than usual")
## factor
df_move.wide$aware_others_moving_f<- factor(df_move.wide$aware_others_moving, levels = ordering)
## ordered factor
df_move.wide$aware_others_moving_of<- factor(df_move.wide$aware_others_moving, levels = ordering, ordered = TRUE)
## numeric
df_move.wide$aware_others_moving_n<-as.numeric(df_move.wide$aware_others_moving_f)

describe(df_move.wide)

# combine with absorption
df_move_abs<-full_join(df_move.wide, musical_absorption.wide, by = c("Pt_ID", "piece"))
## factor order piece
df_move_abs$piece<-factor(df_move_abs$piece, levels = c("Beethoven", "Schnittke", "Folk"))

df_move_abs%<>%rename("Absorption" = "mus_abs")
```

### Visualize
#### Aware_body
ADQ062 has NAs from having missed two pages of the survey (the after beethoven movement awareness is missing)
```{r}
df_move_abs%>%
  filter(! is.na(aware_body_f))%>%
  ggplot(aes(x= aware_body_f, y = Absorption, fill = aware_body_f))+
  geom_violin()+
  geom_jitter()+
  scale_fill_brewer(palette = "Dark2")+
  stat_summary(fun.data=mean_sdl, mult = 1,
               geom = "pointrange", color = "black")+
  facet_grid(cols = vars(piece), rows = vars(group))+
  theme_minimal()+
  theme(legend.position = "bottom")+
  theme(axis.text.x = element_blank())+
  theme(axis.title.x = element_blank())+
  labs(title = "Aware of Own Body", fill = "Aware Body")
```

#### Aware of own movement
```{r}
df_move_abs%>%
  filter(! aware_movement_f==0)%>% filter(! is.na(aware_movement_f))%>%
  ggplot(aes(x= aware_movement_f, y = Absorption, fill = aware_movement_f))+
  geom_violin()+
  geom_jitter()+
  scale_fill_brewer(palette = "Dark2")+
  stat_summary(fun.data=mean_sdl, mult = 1,
               geom = "pointrange", color = "black")+
  facet_grid(cols = vars(piece),  rows = vars(group))+
  theme_minimal()+
  theme(legend.position = "bottom")+
  theme(axis.text.x = element_blank())+
  theme(axis.title.x = element_blank())+
  labs(title = "Aware of Own Movement", fill = "Aware Movement")
```

#### Aware of other's movement
```{r}
df_move_abs%>%
  filter(! aware_others_moving_f==0)%>% filter(! is.na(aware_others_moving_f))%>%
  ggplot(aes(x= aware_others_moving_f, y = Absorption, fill = aware_others_moving_f))+
  geom_violin()+
  geom_jitter()+
  scale_fill_brewer(palette = "Dark2")+
  stat_summary(fun.data=mean_sdl, mult = 1,
               geom = "pointrange", color = "black")+
  facet_grid(cols = vars(piece), rows = vars(group))+
  theme_minimal()+
  theme(legend.position = "bottom")+
  theme(axis.text.x = element_blank())+
  theme(axis.title.x = element_blank())+
  labs(title = "Aware of Other's Movement", fill = "Aware Other's Movement")
```

### Test: Rmcorr
Finn suggests I could run a rank U test to examine whether there were differing absorption levels across different response options. There is a categorical distinction between not aware and aware.

Absorption and Awareness are repeated measures therefore a Mann-Whitney U test is actually not what we need. 

Is there a relation between awareness and absorption? Repeated measures correlation with Spearman would be able to assess this. I don't think that rmcorr can be changed to be used with Spearman but I can just try to see if there is an observed correlation 
```{r}
# aware body: NS
rmc<-rmcorr(Pt_ID, aware_body_n,Absorption, df_move_abs)
rmc
plot(rmc, overall = TRUE)

# aware movement: SIG
rmc<-rmcorr(Pt_ID, aware_movement_n,Absorption, df_move_abs)
rmc
plot(rmc, overall = TRUE)

# aware others movement: SIG
rmc<-rmcorr(Pt_ID, aware_others_moving_n,Absorption, df_move_abs)
rmc
plot(rmc, overall = TRUE)

```

### Test: LME
One resource suggests that for ordinal predictors in lme, you can either choose to treat it as a factor (categorical) or numeric (continuous). https://stats.stackexchange.com/questions/230802/including-ordinal-independent-variables-in-a-linear-mixed-effects-model-using-t

Here is a description of how to interpret output of R and lme based on the data type of the predictor variables: https://stackoverflow.com/questions/25735636/interpretation-of-ordered-and-non-ordered-factors-vs-numerical-predictors-in-m/25736023#25736023

Modelling the random effects structure appropriately is important. It could be modeled with a random intercept or a ranodm intercept and slope. The only way to model with a random slope is to treat the predictor variable as numeric.

Testing with mixed ANOVA is not possible because there are some design cells that are empty (cases where less than 3 people reported the same awareness level). Testing with ANCOVA does not allow for a repeated measures design. Including a random slope in addition to the random intercept may prevent the model from converging.

Is a random slope of participant necessary?

```{r}
aov.dat<-df_move_abs%>%
  filter(! is.na(aware_body))%>%
  filter(! is.na(aware_movement))%>%
  filter(! is.na(aware_others_moving))%>%
  drop_na()
```

#### Check assumptions
Aware body: 
assumptions satisfied.
Two outliers, no extreme

Aware Movement: 
4 outliers, none extreme.

The assumptions may be a bit violated for these tests but the figure doesn’t indicate differences by report and the test did not detect significant differences.

Aware others movement:
There is just one individual in one of the groups so it is unlikely that this is how we should do the test, however the figure does not really indicate differences between groups and the test did not report any significant differences.

```{r}
check_assumptions_f<-aov.dat%>%select(Pt_ID, piece, group, aware_body_f, aware_movement_f, aware_others_moving_f,Absorption)
# Outliers
check_assumptions_f%>%group_by(piece, group)%>%identify_outliers(Absorption) 
check_assumptions_f%>%group_by(piece, aware_body_f)%>%identify_outliers(Absorption)
check_assumptions_f%>%group_by(piece, aware_movement_f)%>%identify_outliers(Absorption)
check_assumptions_f%>%group_by(piece, aware_others_moving_f)%>%identify_outliers(Absorption)

# Normality
aov.dat%>%group_by(piece, group)%>%shapiro_test(Absorption) # Normality assumption not met for any live piece
aov.dat%>%group_by(piece, aware_body_f)%>%shapiro_test(Absorption) # not met for several
aov.dat%>%group_by(piece, aware_movement_f)%>%shapiro_test(Absorption) # not met for several
#aov.dat%>%group_by(piece, aware_others_moving)%>%shapiro_test(Absorption) # One group has only one person therefore this test wouldn't run

# at high sample sizes normality is easily violated therefore a qqplot could be a better test
ggqqplot(aov.dat, "Absorption", ggtheme = theme_bw()) +
  facet_grid(piece ~ aware_body_f) 

ggqqplot(aov.dat, "Absorption", ggtheme = theme_bw()) +
  facet_grid(piece ~ aware_movement_f) 

ggqqplot(aov.dat, "Absorption", ggtheme = theme_bw()) +
  facet_grid(piece ~ aware_others_moving_f) 

ggqqplot(aov.dat, "Absorption", ggtheme = theme_bw()) +
  facet_grid(aware_body_f ~ group) 

ggqqplot(aov.dat, "Absorption", ggtheme = theme_bw()) +
  facet_grid(aware_movement_f ~ group) 

ggqqplot(aov.dat, "Absorption", ggtheme = theme_bw()) +
  facet_grid(aware_others_moving_f ~ group) 

# some of these look really bad because there are very uneven samples between responses.

leveneTest(Absorption ~ group, data = aov.dat) # not violated.
```

#### Aware Body
##### Random intercept
Awareness body:
There was a main effect of awareness if body (X2(6)=14.4, p = .025). 
```{r}
baseline<-lmer(Absorption ~ 1 + (1|Pt_ID), data = aov.dat, REML= FALSE)

pieceM<-lmer(Absorption ~ piece + (1|Pt_ID), data = aov.dat, REML= FALSE)
groupM<-lmer(Absorption ~ piece + group + (1|Pt_ID), data = aov.dat, REML= FALSE)
movementM<-lmer(Absorption ~ piece + group + aware_body_f + (1|Pt_ID), data = aov.dat, REML= FALSE) 
movement_groupM<-lmer(Absorption ~ piece + group * aware_body_f + (1|Pt_ID), data = aov.dat, REML= FALSE) 
movement_pieceM<-lmer(Absorption ~ group + piece * aware_body_f + (1|Pt_ID), data = aov.dat, REML= FALSE) 
anova(baseline, pieceM, groupM, movementM, movement_groupM) # no main effect of awareness of body
anova(baseline, pieceM, groupM, movementM, movement_pieceM) # interaction between awareness of body and piece

summary(movement_pieceM)

# visualize the interaction. 
plt<-emmip(movement_pieceM, piece ~ aware_body_f)
plt # this indicates that the significant difference in awareness of body levels was from a trend in people reporting more absorption when they were not aware of their body at all compared to when they were intermittently aware
plt+
  theme_minimal()+
  labs(title = "Interaction between Aware of Body and Piece", color = "Piece", x = "Aware of Body", y = "Linear Prediction of Absorption")
  
graphname<-"../revised_plots/aware_body_x_piece.png"
ggsave(graphname, width = 15, height = 10, units = 'cm', dpi = 500)

# pairwise tests
movement_pieceM.emm.ab<-emmeans(movement_pieceM, pairwise ~ aware_body_f|piece) #
movement_pieceM.emm.ab

movement_pieceM.emm.ab<-emmeans(movement_pieceM, pairwise ~ piece|aware_body_f) #
movement_pieceM.emm.ab
```

#### Awareness of movement
##### Random intercept

```{r}
baseline<-lmer(Absorption ~ 1 + (1|Pt_ID), data = aov.dat, REML= FALSE)

# factor option - NS
pieceM<-lmer(Absorption ~ piece + (1|Pt_ID), data = aov.dat, REML= FALSE)
groupM<-lmer(Absorption ~ piece + group + (1|Pt_ID), data = aov.dat, REML= FALSE)
movementM<-lmer(Absorption ~ piece + group + aware_movement_f + (1|Pt_ID), data = aov.dat, REML= FALSE) # NS
movement_groupM<-lmer(Absorption ~ piece + group*aware_movement_f + (1|Pt_ID), data = aov.dat, REML= FALSE) #NS
movement_pieceM<-lmer(Absorption ~ group + piece*aware_movement_f + (1|Pt_ID), data = aov.dat, REML= FALSE) #NS

anova(baseline, pieceM, groupM, movementM, movement_groupM) # aware movement is not significant with a random intercept
anova(baseline, pieceM, groupM, movementM, movement_pieceM) # aware movement is not significant with a random intercept

```

#### Awareness of others' movement 
##### Random intercept
```{r}
baseline<-lmer(Absorption ~ 1 + (1|Pt_ID), data = aov.dat, REML= FALSE)

# factor
pieceM<-lmer(Absorption ~ piece + (1|Pt_ID), data = aov.dat, REML= FALSE)
groupM<-lmer(Absorption ~ piece + group + (1|Pt_ID), data = aov.dat, REML= FALSE)
movementM<-lmer(Absorption ~ piece + group + aware_others_moving_f + (1|Pt_ID), data = aov.dat, REML= FALSE) # sig

movement_groupM<-lmer(Absorption ~ piece + group*aware_others_moving_f + (1|Pt_ID), data = aov.dat, REML= FALSE) # NS
movement_pieceM<-lmer(Absorption ~ group + piece*aware_others_moving_f + (1|Pt_ID), data = aov.dat, REML= FALSE) # SIG

anova(baseline, pieceM, groupM, movementM, movement_groupM)
anova(baseline, pieceM, groupM, movementM, movement_pieceM) # interaction between awareness of others motion and piece effects on absorption p = .006
```

*Post-hoc testing*
```{r}
# factor model
movement_pieceM<-lmer(Absorption ~ group + piece*aware_others_moving_f + (1|Pt_ID), data = aov.dat, REML= FALSE) # SIG

summary(movement_pieceM)

# visualize the interaction
plt<-emmip(movement_pieceM, piece ~ aware_others_moving_f)
plt

plt+
  theme_minimal()+
  #theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 15))+
  labs(title = "Interaction between Aware of Others Moving and Piece", color = "Piece", x = "Aware of Others Moving", y = "Linear Prediction of Absorption")
  
graphname<-"../revised_plots/aware_others_moving_x_piece.png"
ggsave(graphname, width = 15, height = 10, units = 'cm', dpi = 500)

# Post-hoc testing
movement_pieceM.emm.aom<-emmeans(movement_pieceM, pairwise ~ aware_others_moving_f|piece) #
movement_pieceM.emm.aom

movement_pieceM.emm.aom<-emmeans(movement_pieceM, pairwise ~ piece|aware_others_moving_f) #
movement_pieceM.emm.aom

movement_pieceM.emm<-emmeans(movement_pieceM, ~ aware_others_moving_f * piece) #
pairs(movement_pieceM.emm, simple = "piece")
# People who reported being aware of others movement and that they moved a normal amount reported higher absorption in the folk than the Schnittke and the Beethoven
pairs(movement_pieceM.emm, simple = "aware_others_moving_f")
# There was a significant difference in people's reports of awareness and absorption in the Schnittke piece such that people who reported not being aware of others' motion reported more absorption than those who reported they were aware and they moved a normal amount (t(320)=3.125, p = .010)

#check sample sizes
aov.dat%>%group_by(piece, aware_others_moving_f)%>%summarize(n())
aov.dat%>%group_by(piece, aware_movement_f)%>%summarize(n())
aov.dat%>%group_by(piece, aware_body_f)%>%summarize(n())
```